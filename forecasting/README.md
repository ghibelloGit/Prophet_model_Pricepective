# Forecasting with Prophet

This guide explains, in plain language, how the training script `forecasting/train_prophet.py` builds demand forecasts from the CSVs generated by `csvgenerator.html`. It covers the inputs it expects, the features (“regressors”) it uses, how it evaluates accuracy, and how to run it from the command line.

**Who is this for?**
- Product managers, engineers, and non–data scientists who want to understand and operate the forecasting pipeline without digging through code.

**What it does**
- Loads one or more CSVs, cleans them, and aggregates sales per day.
- Adds calendar and promotion features to help the model learn demand patterns.
- Trains a Prophet time‑series model for each category or product.
- Evaluates accuracy and saves forecasts, model files, and metrics.

## Input Data
- Minimal required columns: `date`, `quantitySold`, `category`, `productName`.
- Optional helpful columns: `listPrice`, `unitPrice`, `inSeason`, `season`, `promotional`, `discountRate`, `isPayday`, `isDoubleDay`, `isWeekend`, `promoType`.
- Labels must match the generator’s normalized values:
  - `season`: `Christmas`, `Summer`, `Back-to-School`, `Rainy`.
  - `promoType`: `none`, `regular`, `payday`, `double_day`, `holiday`.
- Legacy note: If a CSV has `seasonality` (0/1) but not `inSeason`, it is mapped to `inSeason` automatically.

## Regressors (Features)
These are the signals the model uses alongside the target (`quantitySold`) to explain and predict demand.

- Deterministic In‑Season (`inSeasonDeterministic`)
  - A simple month‑based flag that reflects when a category is “in season”.
  - Examples: Skincare peaks in `Mar–May` and `Aug–Oct`; Makeup peaks around holiday months `Nov–Feb`.
- Calendar Flags
  - `isWeekend`: Saturday/Sunday.
  - `isPayday`: 15th and last day of each month.
  - `isDoubleDay`: “double digit” sale days where `month == day` (e.g., 11/11).
- Promotions
  - `promotional` (0/1): whether the day had a promotion.
  - `promoType_*`: one‑hot columns created from `promoType` (`none`, `regular`, `payday`, `double_day`, `holiday`).
  - `discountRate` (0–1): size of discount; modeled multiplicatively so deeper discounts lift demand more.
- Price
  - `unitPrice`: modeled multiplicatively to capture price elasticity (higher price → lower demand, all else equal).
- Season Labels
  - `season_*`: one‑hot columns created from `season` (`Christmas`, `Summer`, `Back-to-School`, `Rainy`).
- Holidays (Prophet holiday calendar)
  - Adds special days with windows: `payday`, `double_day`, and a `christmas` window (30 days before to 10 days after Dec 25).
- Optional Monthly Seasonality
  - A Fourier seasonality (monthly cycle) if enabled by grid search.

## Training Flow
- Load CSVs from `--data-dir` and normalize columns.
- Group by either:
  - Category (`--mode category`) → one model per category; or
  - Product (`--mode product`) → one model per `Category__Product`.
- Build daily features:
  - Derive `isWeekend`, `isPayday`, `isDoubleDay` from `date`.
  - One‑hot encode `promoType` → `promoType_*` and `season` → `season_*` when present.
  - Aggregate to one row per day and fill missing days for continuity.
  - Add `inSeasonDeterministic` based on category and month.
- Construct holiday calendar (`payday`, `double_day`, `christmas`).
- Train Prophet:
  - Always uses weekly and yearly seasonality.
  - Adds the regressors above (additive by default; price/discount are multiplicative).
  - Optionally runs a small hyperparameter grid (`--grid`) to find better fit.
- Evaluate accuracy:
  - Cross‑validation uses your `--horizon`.
  - Backtesting holdout uses a stable window: max of `14 days`, `20% of history`, and a minimum of `7 days`.
  - Selects the best model using weighted MAPE (robust with low‑volume days).
- Forecast and Save:
  - Forecast `--horizon` days ahead (clamped to `7–30`).
  - Saves forecasts, model pickle, and a metrics row per group.

## Evaluation & Metrics
- `mape`: mean absolute percentage error from Prophet cross‑validation.
- `holdout_mape` and `holdout_accuracy`: backtest metrics from the final 14‑day/20% window.
  - `holdout_accuracy = max(0, 1 - weighted_mape)`; higher is better.
- Metrics are saved to: `forecasting/output/<mode>/metrics.csv`.

## CLI Usage
- Train categories (all), 14‑day horizon:
  - `python forecasting/train_prophet.py --mode category --horizon 14 --output-dir forecasting/output`
- Train with grid search for two categories:
  - `python forecasting/train_prophet.py --mode category --grid --include-groups "Hair Care,Skincare" --horizon 14`
- Train by product within categories:
  - `python forecasting/train_prophet.py --mode product --horizon 30`
- Data location:
  - Use `--data-dir <path>` if your CSVs live elsewhere.

## Outputs
- Forecasts: `forecasting/output/<mode>/forecast_<group>.csv` with `ds`, `yhat`, `yhat_lower`, `yhat_upper`.
- Models: `forecasting/output/<mode>/model_<group>.pkl`.
- Metrics: `forecasting/output/<mode>/metrics.csv` with columns like `group`, `mape`, `holdout_mape`, `holdout_accuracy`, and `params`.

## Forecast Horizon
- The script enforces a practical forecast window between `7` and `30` days (`--horizon` is clamped).
- This keeps evaluation stable and predictions actionable for weekly/bi‑weekly/monthly planning.

## Compatibility Notes
- CSVs from `csvgenerator.html` already emit the correct schema and normalized labels.
- If you use your own CSVs, ensure labels match exactly (case‑sensitive) or add a mapping layer before training.

## When to Retrain
- Retrain when:
  - Schema changes (new/removed columns or label values).
  - Category lineup or product mix changes meaningfully.
  - Price and promotion behavior shifts (new promo types, deeper discounts).
  - You ingest new weeks/months of data and want the latest fit.
- You do not need to retrain just because labels were normalized; that improves consistency.

## Troubleshooting
- `cmdstanpy` informational logs (chains starting/finishing) indicate normal progress — don’t terminate unless you see repeated errors.
- If metrics degrade on very short windows, try `--horizon 14` (more stable), and enable `--grid` for better fit.
- If forecasts look flat, ensure your CSVs have variation in `promotional`, `discountRate`, and `unitPrice`, and that `season`/`promoType` labels are present.

For questions or changes (e.g., adding new promo types or seasons), update the generator and ensure the same labels appear in your training CSVs.

This folder contains a training pipeline to fit Prophet models on the CSV datasets generated by `csvgenerator.html`.

## Quick Start (Windows)

1. Create a virtual environment in the project root:

   - `python -m venv .venv`
   - `./.venv/Scripts/python -m pip install --upgrade pip`
   - `./.venv/Scripts/python -m pip install -r forecasting/requirements.txt`

2. Run the training script for category-level forecasts:

   - `./.venv/Scripts/python forecasting/train_prophet.py --mode category --data-dir . --horizon 30 --output-dir forecasting/output`

3. Run for product-level forecasts within each category:

   - `./.venv/Scripts/python forecasting/train_prophet.py --mode product --data-dir . --horizon 30 --output-dir forecasting/output`

Outputs are saved in `forecasting/output/` including per-series metrics and forecasts.

## Notes

- The pipeline uses Philippine retail calendar events (paydays, double-digit sale days, Christmas season) as holidays to capture demand spikes.
- Category-specific seasonality is provided as deterministic regressors so the model knows when a category is “in season”.
- If future promotion details are unknown, forecasts assume no promotions ahead. For best accuracy, provide a planned promotion calendar.